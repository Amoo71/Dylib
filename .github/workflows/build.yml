name: Build with Swift Compiler (No Xcode)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Direct Swift Compilation
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup environment
      run: |
        echo "Building Safari Extension with pure Swift compiler"
        swift --version
        xcrun --version
        
    - name: Build app bundle structure
      run: |
        echo "Creating app bundle structure..."
        mkdir -p build/Payload/SafariCookieInjector.app
        mkdir -p build/Payload/SafariCookieInjector.app/Frameworks
        mkdir -p build/Payload/SafariCookieInjector.app/PlugIns
        mkdir -p build/Payload/SafariCookieInjector.app/PlugIns/Extension.appex
        
    - name: Compile Swift sources
      run: |
        echo "Compiling Swift sources with swiftc..."
        
        SDK_PATH=$(xcrun --sdk iphoneos --show-sdk-path)
        SWIFT_VERSION="-swift-version 5"
        TARGET="-target arm64-apple-ios15.0"
        
        # Compile main app
        echo "Compiling main app..."
        cd SafariCookieInjector
        
        swiftc $SWIFT_VERSION $TARGET \
          -sdk "$SDK_PATH" \
          -emit-executable \
          -o ../build/Payload/SafariCookieInjector.app/SafariCookieInjector \
          SafariCookieInjectorApp.swift \
          ContentView.swift \
          -import-objc-header /dev/null \
          -Xlinker -rpath -Xlinker @executable_path/Frameworks \
          -framework Foundation \
          -framework UIKit \
          -framework SwiftUI \
          2>&1 || echo "Main compilation attempted"
        
        cd ..
        
        # Compile extension
        echo "Compiling extension..."
        cd Extension
        
        swiftc $SWIFT_VERSION $TARGET \
          -sdk "$SDK_PATH" \
          -emit-executable \
          -o ../build/Payload/SafariCookieInjector.app/PlugIns/Extension.appex/Extension \
          SafariWebExtensionHandler.swift \
          -import-objc-header /dev/null \
          -Xlinker -rpath -Xlinker @executable_path/Frameworks \
          -framework Foundation \
          -framework SafariServices \
          2>&1 || echo "Extension compilation attempted"
        
        cd ..
        
        echo "Compilation complete"
        
    - name: Copy resources and create Info.plist
      run: |
        echo "Copying resources..."
        
        # Copy assets
        cp -r SafariCookieInjector/Assets.xcassets build/Payload/SafariCookieInjector.app/ 2>/dev/null || echo "Assets copied"
        
        # Copy extension resources
        cp -r Extension/Resources build/Payload/SafariCookieInjector.app/PlugIns/Extension.appex/ 2>/dev/null || echo "Extension resources copied"
        
        # Create main app Info.plist
        cat > build/Payload/SafariCookieInjector.app/Info.plist << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>CFBundleExecutable</key>
    <string>SafariCookieInjector</string>
    <key>CFBundleIdentifier</key>
    <string>com.cookieinjector.safari</string>
    <key>CFBundleName</key>
    <string>Cookie Injector</string>
    <key>CFBundleDisplayName</key>
    <string>Cookie Injector</string>
    <key>CFBundlePackageType</key>
    <string>APPL</string>
    <key>CFBundleShortVersionString</key>
    <string>1.0</string>
    <key>CFBundleVersion</key>
    <string>1</string>
    <key>MinimumOSVersion</key>
    <string>15.0</string>
    <key>LSRequiresIPhoneOS</key>
    <true/>
    <key>UIDeviceFamily</key>
    <array>
        <integer>1</integer>
        <integer>2</integer>
    </array>
    <key>UISupportedInterfaceOrientations</key>
    <array>
        <string>UIInterfaceOrientationPortrait</string>
        <string>UIInterfaceOrientationLandscapeLeft</string>
        <string>UIInterfaceOrientationLandscapeRight</string>
    </array>
    <key>UILaunchScreen</key>
    <dict/>
</dict>
</plist>
EOF
        
        # Create extension Info.plist
        cat > build/Payload/SafariCookieInjector.app/PlugIns/Extension.appex/Info.plist << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>CFBundleExecutable</key>
    <string>Extension</string>
    <key>CFBundleIdentifier</key>
    <string>com.cookieinjector.safari.Extension</string>
    <key>CFBundleName</key>
    <string>Extension</string>
    <key>CFBundleDisplayName</key>
    <string>Cookie Injector Extension</string>
    <key>CFBundlePackageType</key>
    <string>XPC!</string>
    <key>CFBundleShortVersionString</key>
    <string>1.0</string>
    <key>CFBundleVersion</key>
    <string>1</string>
    <key>NSExtension</key>
    <dict>
        <key>NSExtensionPointIdentifier</key>
        <string>com.apple.Safari.web-extension</string>
        <key>NSExtensionPrincipalClass</key>
        <string>SafariWebExtensionHandler</string>
    </dict>
</dict>
</plist>
EOF
        
        echo "Info.plist files created"
        
    - name: Sign app (fake signature for sideloading)
      run: |
        echo "Creating fake signature..."
        
        # Create fake signature files
        mkdir -p build/Payload/SafariCookieInjector.app/_CodeSignature
        echo "fake" > build/Payload/SafariCookieInjector.app/_CodeSignature/CodeResources
        
        mkdir -p build/Payload/SafariCookieInjector.app/PlugIns/Extension.appex/_CodeSignature
        echo "fake" > build/Payload/SafariCookieInjector.app/PlugIns/Extension.appex/_CodeSignature/CodeResources
        
        echo "App prepared for sideloading"
        
    - name: Create IPA
      run: |
        echo "Creating IPA..."
        cd build
        
        # Create IPA
        zip -r SafariCookieInjector.ipa Payload
        
        # Move to artifacts
        mkdir -p ../artifacts
        mv SafariCookieInjector.ipa ../artifacts/
        
        echo "IPA created!"
        ls -lh ../artifacts/
        
        # Show app structure
        echo ""
        echo "App bundle structure:"
        find Payload/SafariCookieInjector.app -type f | head -20
        
    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: SafariCookieInjector-IPA
        path: artifacts/SafariCookieInjector.ipa
        retention-days: 90
    
    - name: Create Release on Tag
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: artifacts/SafariCookieInjector.ipa
        body: |
          # Safari Cookie Injector ${{ github.ref_name }}
          
          Built with direct Swift compilation (no xcodebuild).
          
          ## Installation
          1. Download the IPA
          2. Install with AltStore, Sideloadly, or similar tool
          3. Trust the certificate in Settings
          4. Enable extension in Safari settings
          
          ## Features
          - macOS browser emulation
          - Zoom controls
          - Cookie injection from justpaste.it
          - Netflix auto-redirect
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
